<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Hitachi Print Debug — TWA Safe (v)</title>

  <style>
    :root {
      --ink:#0e0e0e; --muted:#6b7280; --bg:#f7f7f9; --card:#fff; --axis:#A10054;
      --shadow:0 10px 30px rgba(0,0,0,.06), 0 2px 10px rgba(0,0,0,.04);
      --r:16px;
    }
    * { box-sizing: border-box }
    html, body { height: 100% }
    body { margin: 0; font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif; color: var(--ink); background: var(--bg)}
    .container { max-width: 980px; margin: 0 auto; padding: 18px }
    header { display:flex; align-items:center; justify-content:space-between; gap: 12px; margin-bottom: 16px }
    .brand { display:flex; align-items:center; gap: 10px; }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:8px 12px; font-weight:700; border-radius: 999px; background: rgba(161,0,84,.1); color: var(--axis) }
    .ver { font: 12px/1.2 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; color: var(--muted) }
    .card { background: var(--card); border-radius: var(--r); box-shadow: var(--shadow); padding: 16px; margin-bottom: 16px }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center }
    .btn { appearance:none; border:0; padding:10px 14px; border-radius: 999px; cursor:pointer; font-weight:600; background:#111; color:#fff }
    .btn.secondary { background: var(--axis) }
    .btn.ghost { background:#eee; color:#111 }
    .field { padding: 10px 12px; border-radius: 12px; border:1px solid rgba(0,0,0,.12); background:#fff }
    #preview { min-height: 140px; display:flex; align-items:center; justify-content:center; border:1px dashed rgba(0,0,0,.12); border-radius: 12px; background:#fff; overflow:hidden }
    #preview img { max-width: 100%; height: auto; display: block }
    #log { white-space: pre-wrap; font: 12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; color: #333; background: #fafafa; border:1px solid #eee; border-radius: 12px; padding: 12px; max-height: 200px; overflow: auto }
    /* the print iframe is tiny but present (avoid fully display:none) */
    #printFrame { width:1px; height:1px; opacity:0; position:fixed; left:0; bottom:0; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <span class="pill">Hitachi • Print Debug</span>
        <span class="ver" id="ver">v</span>
      </div>
      <div class="row">
        <button class="btn ghost" id="btnSmoke">Smoke Test (built-in image)</button>
        <button class="btn ghost" id="btnPagePrint">Window.print()</button>
      </div>
    </header>

    <section class="card">
      <h3 style="margin:0 0 8px;">Upload & Preview</h3>
      <div class="row" style="margin-bottom:10px">
        <input id="file" type="file" class="field" accept="image/*" />
        <button class="btn secondary" id="btnPrintUploaded">Print Uploaded (iframe)</button>
        <button class="btn" id="btnMakePdf">Generate PDF & Download</button>
      </div>
      <div id="preview"><em>no file</em></div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 8px;">Logs</h3>
      <div id="log">ready.</div>
    </section>
  </div>

  <!-- Print iframe -->
  <iframe id="printFrame"></iframe>

  <!-- Local jsPDF with versioning (place the file next to this HTML) -->
  <script>
    /* app version */
    const APP_VERSION = "1.0.4"; // ← bump this when you ship
    document.getElementById('ver').textContent = "v" + APP_VERSION;

    /* simple logger */
    const logEl = document.getElementById('log');
    function log(...args){ logEl.textContent += "\\n" + args.join(" "); logEl.scrollTop = logEl.scrollHeight; }

    /* util: wait double rAF */
    function afterLayout(){ return new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r))); }

    /* print into tiny iframe */
    async function printDataUrlImage(dataUrl, pageSpec="A4") {
      const f = document.getElementById('printFrame');
      const doc = f.contentDocument || f.contentWindow.document;
      doc.open();
      doc.write(`
        <!doctype html><meta charset="utf-8"><title>print</title>
        <style>
          @page { size: ${pageSpec}; margin: 0 }
          html,body{margin:0;padding:0;width:100%;height:100%}
          .page{width:100%;height:100%;display:grid;place-items:center}
          img{max-width:100%;max-height:100%;display:block;object-fit:contain;
              -webkit-print-color-adjust:exact; print-color-adjust:exact}
        </style>
        <div class="page"><img id="im" alt="img"></div>
      `);
      doc.close();

      await new Promise(res => {
        if (f.contentDocument?.readyState === 'complete') res(); else f.onload = res;
      });

      const im = doc.getElementById('im');
      await new Promise((res, rej) => { im.onload=res; im.onerror=()=>rej('img load error'); im.src = dataUrl; });
      if (im.decode) { try { await im.decode(); } catch(e){} }

      await afterLayout();
      try { f.contentWindow.focus(); f.contentWindow.print(); log("print sent"); }
      catch(e){ log("print error:", e.message); }
    }

    /* smoke test: built-in PNG */
    const SMOKE_DATA_URL =
      "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAANAAAADQCAAAAAB2W5o3AAAAA3NCSVQICAjb4U/gAAABcUlEQVR4nO3RMQEAIAzAsE8mS3hS2EJ2o9EJ5u1Aq0r2H9n7AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgEw0d7w1A5q4m0y6w7N8b7oNq8jv0wDqkQJp6Qk+0m7p8w5s7cA1X/4qv4B0s4n0nM4d2TUt2yH7k0b8h7sQ9m8Yw5a8cYw5Y8cYw5Y8cYw5Y8cYw5Y8cYw5Y8cYw5Y8cYw5Y8cYw5Y8cYw5Y8cYw5Y8cYw5Y8cYw5Y8cYw5Y8cYw5Y8cYw5Y8cYw5Y8cYw5Y8cYw5Y8cYw5Y8cYw5Y8cYw5Y8cYw5Y8cYw5Y8cYw5Y8cYw5Y8cYy5dQ6b3gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAICvB8a0zqQq8n4AAAAASUVORK5CYII=";

    document.getElementById('btnSmoke').addEventListener('click', async () => {
      log("smoke: start");
      try { await printDataUrlImage(SMOKE_DATA_URL); }
      catch(e){ log("smoke failed:", e); }
    });

    document.getElementById('btnPagePrint').addEventListener('click', () => {
      log("window.print()");
      try { window.print(); } catch(e){ log("window.print error", e.message); }
    });

    /* upload → rasterize to dataURL (PNG) → preview */
    let lastDataUrl = null;
    document.getElementById('file').addEventListener('change', async e => {
      const f = e.target.files?.[0];
      const prev = document.getElementById('preview');
      prev.innerHTML = '';
      lastDataUrl = null;

      if (!f) { prev.innerHTML = '<em>no file</em>'; return; }
      log("selected:", f.name, f.type || "(no type)", f.size + "B");

      const url = URL.createObjectURL(f);
      const img = new Image();
      img.onload = async () => {
        try {
          const c = document.createElement('canvas');
          // guard against 0×0 images
          c.width  = img.naturalWidth  || img.width  || 1;
          c.height = img.naturalHeight || img.height || 1;
          const ctx = c.getContext('2d', { alpha:false });
          ctx.imageSmoothingEnabled = true;
          ctx.drawImage(img, 0, 0);

          lastDataUrl = c.toDataURL('image/png'); // opaque PNG
          URL.revokeObjectURL(url);

          const pv = new Image();
          pv.src = lastDataUrl;
          prev.appendChild(pv);
          log("rasterized:", c.width + "×" + c.height);
        } catch (err) {
          log("rasterize error:", err.message || err);
          prev.textContent = "rasterize failed";
        }
      };
      img.onerror = () => { URL.revokeObjectURL(url); prev.textContent = "load error"; log("image load error"); };
      img.src = url;
    });

    /* Print uploaded (iframe route) */
    document.getElementById('btnPrintUploaded').addEventListener('click', async () => {
      if (!lastDataUrl) { alert("Upload an image first"); return; }
      log("print uploaded: start");
      try { await printDataUrlImage(lastDataUrl); }
      catch(e){ log("print uploaded error:", e.message || e); }
    });

    /* Load jsPDF with version cache buster, then build A4 PDF from image */
    let jsPdfReady = false;
    async function ensureJsPdf() {
      if (jsPdfReady) return true;
      return new Promise((resolve) => {
        const s = document.createElement('script');
        s.src = "jspdf.umd.min.js?v=" + encodeURIComponent(APP_VERSION);
        s.onload = () => { jsPdfReady = true; resolve(true); };
        s.onerror = () => { log("jsPDF failed to load"); resolve(false); };
        document.head.appendChild(s);
      });
    }

    async function makePdfFromDataUrl(dataUrl) {
      const ok = await ensureJsPdf();
      if (!ok || !window.jspdf) { alert("jsPDF not available"); return; }
      const { jsPDF } = window.jspdf;

      const pdf = new jsPDF({ unit: 'pt', format: 'a4', compress: true });
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();

      const im = new Image();
      await new Promise((res, rej) => { im.onload=res; im.onerror=rej; im.src = dataUrl; });
      const iw = im.naturalWidth || 1, ih = im.naturalHeight || 1;

      const scale = Math.min(pageW/iw, pageH/ih);
      const w = iw * scale, h = ih * scale;
      const x = (pageW - w)/2, y = (pageH - h)/2;

      pdf.addImage(dataUrl, 'PNG', x, y, w, h, undefined, 'FAST');
      // Download; on Android this will route to a viewer and allow printing as a real PDF.
      const fileName = `image_${Date.now()}_v${APP_VERSION}.pdf`;
      pdf.save(fileName);
      log("pdf generated:", fileName, `${Math.round(w)}×${Math.round(h)} on A4`);
    }

    document.getElementById('btnMakePdf').addEventListener('click', async () => {
      if (!lastDataUrl) { alert("Upload an image first"); return; }
      try { await makePdfFromDataUrl(lastDataUrl); }
      catch(e){ log("makePdf error:", e.message || e); }
    });

    // stamp version into <title>
    document.title = document.title.replace(/\(v\)$/, `(v${APP_VERSION})`);
  </script>
</body>
</html>
